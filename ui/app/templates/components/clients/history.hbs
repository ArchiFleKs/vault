{{! TODO CHANGE FILE NAME TO dashboard.hbs }}
<div class="box is-sideless is-fullwidth is-marginless is-bottomless">
  <p class="has-bottom-margin-xl">
    This dashboard will surface Vault client usage over time. Clients represent a user or service that has authenticated to
    Vault. Documentation is available
    <DocLink @path="/docs/concepts/client-count">here</DocLink>.
  </p>
  <h2 class="title is-6 has-bottom-margin-xs">
    {{this.versionText.label}}
  </h2>
  <div data-test-start-date-editor class="is-flex-align-baseline">
    {{#if this.displayStartDate}}
      <p class="is-size-6" data-test-date-display>{{this.displayStartDate}}</p>
      <button type="button" class="button is-link" {{on "click" (fn (mut this.showBillingStartModal) true)}}>
        Edit
      </button>
    {{else}}
      <DateDropdown @handleSubmit={{this.handleClientActivityQuery}} @dateType="startDate" @submitText="Save" />
    {{/if}}
  </div>
  <p class="is-8 has-text-grey has-bottom-margin-xl">
    {{this.versionText.description}}
  </p>
  {{#if (eq @model.config.queriesAvailable false)}}
    {{#if (eq @model.config.enabled "On")}}
      <EmptyState
        @title={{concat "No monthly history " (if this.noActivityDate "from ") this.noActivityDate}}
        @message="There is no data in the monthly history yet. We collect it at the end of each month, so your data will be available on the first of next month."
      />
    {{else}}
      <EmptyState
        @title="Data tracking is disabled"
        @message="Tracking is disabled, and no data is being collected. To turn it on, edit the configuration."
      >
        {{#if @model.config.configPath.canUpdate}}
          <p>
            <LinkTo @route="vault.cluster.clients.config">
              Go to configuration
            </LinkTo>
          </p>
        {{/if}}
      </EmptyState>
    {{/if}}
  {{else if this.errorObject}}
    <Clients::Error @error={{this.errorObject}} />
  {{else}}
    {{#if (eq @model.config.enabled "Off")}}
      <AlertBanner data-test-tracking-disabled @type="warning" @title="Tracking is disabled">
        Tracking is currently disabled and data is not being collected. Historical data can be searched, but you will need to
        <LinkTo @route="vault.cluster.clients.edit">
          edit the configuration
        </LinkTo>
        to enable tracking again.
      </AlertBanner>
    {{/if}}
    {{#if (or this.totalUsageCounts this.hasAttributionData)}}
      <div class="is-subtitle-gray has-bottom-margin-m">
        FILTERS
        <Toolbar data-test-clients-filter-bar>
          <ToolbarFilters>
            <CalendarWidget
              @startTimestamp={{this.startMonthTimestamp}}
              @endTimestamp={{this.endMonthTimestamp}}
              @selectMonth={{this.handleClientActivityQuery}}
            />
            {{#if this.namespaceArray}}
              <SearchSelect
                @id="namespace-search-select"
                @options={{this.namespaceArray}}
                @selectLimit="1"
                @disallowNewItems={{true}}
                @fallbackComponent="input-search"
                @onChange={{this.selectNamespace}}
                @placeholder={{"Filter by namespace"}}
                @displayInherit={{true}}
                class="is-marginless"
              />
            {{/if}}
            {{#if (not (is-empty this.authMethodOptions))}}
              <SearchSelect
                @id="auth-method-search-select"
                @options={{this.authMethodOptions}}
                @selectLimit="1"
                @disallowNewItems={{true}}
                @fallbackComponent="input-search"
                @onChange={{this.setAuthMethod}}
                @placeholder={{"Filter by auth method"}}
                @displayInherit={{true}}
              />
            {{/if}}
          </ToolbarFilters>
        </Toolbar>
      </div>

      {{#if (or this.upgradeDuringActivity this.startTimeDiscrepancy)}}
        <AlertBanner @type="warning" @title="Warning">
          <ul class={{if (and this.versionUpdateText this.startTimeDiscrepancy) "bullet"}}>
            {{#if this.startTimeDiscrepancy}}
              <li>{{this.startTimeDiscrepancy}}</li>
            {{/if}}
            {{#if this.upgradeDuringActivity}}
              <li>
                {{this.upgradeVersionAndDate}}
                {{this.versionSpecificText}}
                <DocLink
                  @path="/docs/concepts/client-count/faq#q-which-vault-version-reflects-the-most-accurate-client-counts"
                >
                  Learn more here.
                </DocLink>
              </li>
            {{/if}}
          </ul>
        </AlertBanner>
      {{/if}}
      {{#if this.isLoadingQuery}}
        <LayoutLoading />
      {{else}}
        {{#if this.totalUsageCounts}}
          {{#unless this.byMonthActivityData}}
            <Clients::UsageStats @title="Total usage" @totalUsageCounts={{this.totalUsageCounts}} />
          {{/unless}}
          {{#if this.byMonthActivityData}}
            <Clients::RunningTotal
              @chartLegend={{this.chartLegend}}
              @selectedAuthMethod={{this.selectedAuthMethod}}
              @lineChartData={{this.byMonthActivityData}}
              @barChartData={{this.byMonthNewClients}}
              @runningTotals={{this.totalUsageCounts}}
              @upgradeData={{this.upgradeDuringActivity}}
              @timestamp={{this.responseTimestamp}}
            />
          {{/if}}
          {{#if this.hasAttributionData}}
            <Clients::Attribution
              @chartLegend={{this.chartLegend}}
              @totalUsageCounts={{this.totalUsageCounts}}
              @newUsageCounts={{this.newClientCounts}}
              @totalClientAttribution={{this.totalClientAttribution}}
              @newClientAttribution={{this.newClientAttribution}}
              @selectedNamespace={{this.selectedNamespace}}
              @startTimeDisplay={{this.startTimeDisplay}}
              @endTimeDisplay={{this.endTimeDisplay}}
              @isDateRange={{this.isDateRange}}
              @timestamp={{this.responseTimestamp}}
            />
          {{/if}}
          {{#if this.hasMultipleMonthsData}}
            <Clients::MonthlyUsage
              @chartLegend={{this.chartLegend}}
              @verticalBarChartData={{this.byMonthActivityData}}
              @timestamp={{this.responseTimestamp}}
            />
          {{/if}}
        {{/if}}
      {{/if}}
    {{else if (and (not @model.licenseStartTimestamp) (not this.startMonthTimestamp))}}
      {{! Empty state for no billing/license start date }}
      <EmptyState @title={{this.versionText.title}} @message={{this.versionText.message}} />
    {{else}}
      <EmptyState
        @title={{concat "No data received " (if this.noActivityDate "from ") this.noActivityDate}}
        @message="No data exists for that query period. Select a different billing start date above, or choose a different end date here:"
      >
        <DateDropdown @handleSubmit={{this.handleClientActivityQuery}} @dateType="endDate" @submitText="View" />
      </EmptyState>
    {{/if}}
  {{/if}}

  {{! BILLING START DATE MODAL }}

  <Modal
    @title="Edit start month"
    @onClose={{action (mut this.showBillingStartModal) false}}
    @isActive={{this.showBillingStartModal}}
    @showCloseButton={{true}}
  >
    <section class="modal-card-custom has-padding-m">
      <p class="has-bottom-margin-s">
        {{this.versionText.description}}
      </p>
      <p><strong>{{this.versionText.label}}</strong></p>
    </section>
    <DateDropdown
      @handleSubmit={{this.handleClientActivityQuery}}
      @dateType="startDate"
      @submitText="Save"
      @handleCancel={{fn this.handleClientActivityQuery (hash dateType="cancel")}}
    />
  </Modal>
</div>